<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Escala ‚Äì RH 1¬∫ BBM</title>
  <link rel="stylesheet" href="css/estilo.css">
  <script src="js/efetivo_real.js"></script>
  <script src="js/calculos.js"></script>
  <script src="js/alertas_avancados.js"></script>
  <style>
    .escala-dia-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 20px;
    }
    .viatura-card {
      background: white;
      border-radius: 8px;
      padding: 15px;
      border-left: 5px solid var(--azul-bombeiro);
      margin-bottom: 15px;
    }
    .alerta-painel {
      background: #fff3cd;
      border-left: 5px solid #ffc107;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="logo-container">
      <img src="https://ciabm-1bbm.github.io/site/logo-cbmrs.png" alt="CBMRS" class="logo" onerror="this.style.display='none'">
      <img src="https://ciabm-1bbm.github.io/site/brasao-rs.png" alt="RS" class="logo" onerror="this.style.display='none'">
      <img src="https://ciabm-1bbm.github.io/site/brasao-1bbm.png" alt="1¬∫ BBM" class="logo" onerror="this.style.display='none'">
    </div>
    <div class="titulo-sistema">üöí SISTEMA RH ‚Äì 1¬∫ BBM</div>
    <div><button class="btn btn-primary" onclick="window.location.href='index.html'">üè† Dashboard</button></div>
  </div>

  <h2 style="color: var(--azul-marinho);">üìÖ ESCALA DE SERVI√áO ‚Äì JANEIRO/2026</h2>

  <!-- Seletor de data e pelot√£o -->
  <div style="display: flex; gap: 20px; margin-bottom: 30px; background: white; padding: 20px; border-radius: 10px;">
    <div>
      <label for="data-escala">Data:</label>
      <input type="date" id="data-escala" value="2026-01-01" onchange="carregarEscalaDia()">
    </div>
    <div>
      <label for="pelotao-escala">Pelot√£o:</label>
      <select id="pelotao-escala" onchange="carregarEscalaDia()">
        <option value="todos">TODOS OS PELOT√ïES</option>
        <option value="A√áORIANOS">A√áORIANOS</option>
        <option value="TERES√ìPOLIS">TERES√ìPOLIS</option>
        <option value="RESTINGA">RESTINGA</option>
        <option value="ASSUN√á√ÉO">ASSUN√á√ÉO</option>
        <option value="BEL√âM NOVO">BEL√âM NOVO</option>
        <option value="FLORESTA">FLORESTA</option>
        <option value="PASSO D'AREIA">PASSO D'AREIA</option>
        <option value="PARTENON">PARTENON</option>
      </select>
    </div>
    <div style="margin-left: auto;">
      <button class="btn btn-success" onclick="calcularHE()">üßÆ RECALCULAR HE</button>
    </div>
  </div>

  <!-- Painel de Alertas do Dia -->
  <div id="painel-alertas" class="alerta-painel"></div>

  <!-- Visualiza√ß√£o da Escala por Pelot√£o/Viatura -->
  <div id="escala-container" style="background: white; padding: 20px; border-radius: 10px;">
    <h3 style="margin-bottom: 20px;">üöí ESCALA DO DIA <span id="data-selecionada"></span></h3>
    <div id="escala-dia-conteudo" style="min-height: 300px;">
      <p style="color: #666; text-align: center;">Selecione uma data para visualizar a escala.</p>
    </div>
  </div>

  <div style="margin-top: 30px; display: flex; justify-content: flex-end; gap: 15px;">
    <button class="btn btn-primary" onclick="window.location.href='relatorios.html'">üìÑ GERAR MAPAS</button>
  </div>

  <script>
    // Banco de dados da escala
    let escalaDB = JSON.parse(localStorage.getItem('escala_1bbm')) || [];
    const efetivo = efetivoReal;

    // Fun√ß√£o para carregar escala do dia
    function carregarEscalaDia() {
      const data = document.getElementById('data-escala').value;
      const pelotaoFiltro = document.getElementById('pelotao-escala').value;
      
      document.getElementById('data-selecionada').innerText = data;
      
      let escalaDia = escalaDB.filter(e => e.data === data);
      
      if (pelotaoFiltro !== 'todos') {
        escalaDia = escalaDia.filter(e => e.pelotao === pelotaoFiltro);
      }
      
      // Agrupar por pelot√£o e viatura
      const pelotoesNaData = [...new Set(escalaDia.map(e => e.pelotao))];
      
      let html = '';
      
      if (escalaDia.length === 0) {
        html = '<p style="color: #666; text-align: center;">Nenhum servi√ßo lan√ßado para esta data.</p>';
      } else {
        pelotoesNaData.forEach(pel => {
          const militaresPel = escalaDia.filter(e => e.pelotao === pel);
          const covsPel = militaresPel.filter(e => e.funcao === 'COV' || e.funcao === 'COV AEM').length;
          
          html += `<div style="margin-bottom: 25px; background: #f8f9fa; padding: 15px; border-radius: 8px;">`;
          html += `<h4 style="color: var(--azul-marinho); border-bottom: 2px solid var(--azul-bombeiro); padding-bottom: 5px;">`;
          html += `üöí Pelot√£o ${pel} ${covsPel < 1 ? 'üî¥ FALTA COV' : covsPel === 1 ? 'üü° 1 COV' : 'üü¢ OK'}`;
          html += `</h4>`;
          
          // Viaturas
          html += `<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px;">`;
          
          // ABT (Auto Bomba Tanque)
          html += `<div class="viatura-card">`;
          html += `<strong>ABT (Caminh√£o)</strong>`;
          const abtMilitares = militaresPel.filter(e => e.viatura === 'ABT' || !e.viatura);
          if (abtMilitares.length > 0) {
            abtMilitares.forEach(m => {
              html += `<div style="display: flex; justify-content: space-between; margin-top: 5px;">`;
              html += `<span>${m.nome} (${m.posto})</span>`;
              html += `<span style="background: #e0e0e0; padding: 2px 8px; border-radius: 12px;">${m.funcao}</span>`;
              html += `</div>`;
            });
          } else {
            html += `<p style="color: #999; margin-top: 10px;">Nenhum militar escalado</p>`;
          }
          html += `</div>`;
          
          // AR (Auto Resgate)
          html += `<div class="viatura-card">`;
          html += `<strong>AR (Resgate)</strong>`;
          const arMilitares = militaresPel.filter(e => e.viatura === 'AR');
          if (arMilitares.length > 0) {
            arMilitares.forEach(m => {
              html += `<div style="display: flex; justify-content: space-between; margin-top: 5px;">`;
              html += `<span>${m.nome} (${m.posto})</span>`;
              html += `<span style="background: #e0e0e0; padding: 2px 8px; border-radius: 12px;">${m.funcao}</span>`;
              html += `</div>`;
            });
          } else {
            html += `<p style="color: #999; margin-top: 10px;">Nenhum militar escalado</p>`;
          }
          html += `</div>`;
          
          html += `</div>`; // Fim grid
          html += `</div>`; // Fim pelot√£o
        });
      }
      
      document.getElementById('escala-dia-conteudo').innerHTML = html;
      
      // Gerar alertas do dia
      gerarAlertasDia(data, pelotaoFiltro);
    }

    function gerarAlertasDia(data, pelotao) {
      const alertas = gerarAlertasCompletos(efetivo, escalaDB, 1, 2026);
      const painel = document.getElementById('painel-alertas');
      
      let html = '<strong>üö¶ ALERTAS DO DIA:</strong><ul style="margin: 10px 0 0 20px;">';
      
      // Alertas de d√©ficit de COV
      const alertaCOV = alertas.deficitCOV.find(a => a.data === data);
      if (alertaCOV) {
        html += `<li style="color: #b71c1c;">üî¥ D√©ficit de COV: ${alertaCOV.covsEscalados} escalado(s), necess√°rio ${alertaCOV.necessarios} (faltam ${alertaCOV.deficit})</li>`;
      }
      
      // Alertas de desequil√≠brio de horas
      const alertasHoras = alertas.desequilibrioHoras.slice(0, 3);
      alertasHoras.forEach(a => {
        html += `<li style="color: ${a.cor === 'üî¥' ? '#b71c1c' : '#b76e1e'};">${a.cor} ${a.mensagem}</li>`;
      });
      
      if (alertasCOV.length === 0 && alertasHoras.length === 0) {
        html += '<li style="color: #2e7d32;">üü¢ Nenhum alerta cr√≠tico para este dia.</li>';
      }
      
      html += '</ul>';
      painel.innerHTML = html;
    }

    function calcularHE() {
      const resultado = calcularTodasHE(escalaDB, efetivo, parametros);
      localStorage.setItem('resultado_he', JSON.stringify(resultado));
      
      alert(`üßÆ C√°lculo conclu√≠do!\n\nüìä RESULTADOS ‚Äì JANEIRO/2026\n
      ‚Ä¢ Total de HE: ${resultado.totalHE}h
      ‚Ä¢ Valor GSE: R$ ${resultado.totalGSE.toFixed(2)}
      ‚Ä¢ Total Etapas: ${resultado.totalEtapas}
      ‚Ä¢ Valor Etapas: R$ ${resultado.totalValorEtapas.toFixed(2)}`);
      
      carregarEscalaDia();
    }

    // Inicializa√ß√£o
    window.onload = function() {
      const hoje = new Date().toISOString().split('T')[0];
      document.getElementById('data-escala').value = '2026-01-01';
      carregarEscalaDia();
    };
  </script>
</body>
</html>